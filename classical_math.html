<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#4A90D9">
  <title>Math Practice - Classical Kids Study Hub</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”¢</text></svg>">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Math Page Specific Enhancements */
    .game-card {
      position: relative;
      overflow: hidden;
    }
    .game-card::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s ease;
    }
    .game-card:hover::after {
      left: 100%;
    }
    .game-icon {
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .game-card:hover .game-icon {
      transform: scale(1.2) rotate(-5deg);
    }
    .problem-area {
      position: relative;
    }
    .streak-fire {
      position: absolute;
      top: -30px;
      right: 20px;
      font-size: 2rem;
      animation: fire-bounce 0.5s ease infinite alternate;
    }
    @keyframes fire-bounce {
      from { transform: translateY(0) scale(1); }
      to { transform: translateY(-5px) scale(1.1); }
    }
    .answer-input:focus {
      animation: input-glow 1.5s ease infinite;
    }
    @keyframes input-glow {
      0%, 100% { box-shadow: 0 0 0 4px rgba(74,144,217,0.15); }
      50% { box-shadow: 0 0 0 8px rgba(74,144,217,0.1); }
    }
    .stat-value {
      transition: transform 0.3s ease;
    }
    .stat-value.bump {
      animation: stat-bump 0.3s ease;
    }
    @keyframes stat-bump {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    .math-hero {
      position: relative;
    }
    .math-hero .floating-nums {
      position: absolute;
      font-size: 2rem;
      opacity: 0.15;
      animation: float-num 4s ease-in-out infinite;
    }
    @keyframes float-num {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(10deg); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo"><div class="logo-icon">ğŸ“š</div><span>Classical Kids</span></a>
      <div class="lang-toggle">
        <button class="lang-btn active" data-lang="en" onclick="setLang('en')">EN</button>
        <button class="lang-btn" data-lang="es" onclick="setLang('es')">ES</button>
      </div>
      <nav class="header-nav">
        <a href="index.html" class="nav-link"><span class="nav-link-icon">ğŸ </span> <span data-i18n="home">Home</span></a>
        <a href="resources.html" class="nav-link"><span class="nav-link-icon">ğŸ“–</span> <span data-i18n="resources">Resources</span></a>
        <a href="classical_math.html" class="nav-link active"><span class="nav-link-icon">ğŸ”¢</span> <span data-i18n="math">Math</span></a>
        <a href="dashboard.html" class="nav-link"><span class="nav-link-icon">ğŸ“Š</span> <span data-i18n="progress">Progress</span></a>
        <a href="parents-guide.html" class="nav-link"><span class="nav-link-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span> <span data-i18n="parents">Parents</span></a>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="container">
      
      <!-- MENU SECTION -->
      <section id="menuSection">
        <div class="math-hero">
          <div class="floating-nums" style="top:20%;left:10%;animation-delay:0s;">Ï€</div>
          <div class="floating-nums" style="top:30%;right:15%;animation-delay:1s;">âˆ‘</div>
          <div class="floating-nums" style="bottom:20%;left:20%;animation-delay:2s;">âˆš</div>
          <div class="floating-nums" style="bottom:30%;right:10%;animation-delay:0.5s;">âˆ</div>
          <h1 data-i18n="mathPractice">ğŸ”¢ Math Practice</h1>
          <p data-i18n="mathSubtitle">Choose a topic and sharpen your skills!</p>
        </div>
        
        <div class="game-grid" id="gameGrid">
          <div class="game-card" data-mode="counting"><div class="game-icon">ğŸ</div><div class="game-title" data-i18n="counting">Counting</div></div>
          <div class="game-card" data-mode="addition"><div class="game-icon">â•</div><div class="game-title" data-i18n="addition">Addition</div></div>
          <div class="game-card" data-mode="subtraction"><div class="game-icon">â–</div><div class="game-title" data-i18n="subtraction">Subtraction</div></div>
          <div class="game-card" data-mode="multiplication"><div class="game-icon">âœ–ï¸</div><div class="game-title" data-i18n="multiplication">Multiplication</div></div>
          <div class="game-card" data-mode="division"><div class="game-icon">â—</div><div class="game-title" data-i18n="division">Division</div></div>
          <div class="game-card" data-mode="fractions"><div class="game-icon">ğŸ¥§</div><div class="game-title" data-i18n="fractions">Fractions</div></div>
          <div class="game-card" data-mode="geometry"><div class="game-icon">ğŸ“</div><div class="game-title" data-i18n="geometry">Geometry</div></div>
          <div class="game-card" data-mode="time"><div class="game-icon">ğŸ•</div><div class="game-title" data-i18n="time">Time</div></div>
          <div class="game-card" data-mode="money"><div class="game-icon">ğŸ’°</div><div class="game-title" data-i18n="money">Money</div></div>
          <div class="game-card" data-mode="measurement"><div class="game-icon">ğŸ“</div><div class="game-title" data-i18n="measurement">Measurement</div></div>
          <div class="game-card" data-mode="patterns"><div class="game-icon">ğŸ”¢</div><div class="game-title" data-i18n="patterns">Patterns</div></div>
          <div class="game-card" data-mode="challenge" style="background: linear-gradient(135deg, #9B5DE5, #4A90D9); color: white;"><div class="game-icon">ğŸ§ </div><div class="game-title" data-i18n="challenge">Challenge</div></div>
        </div>
      </section>

      <!-- LESSON SECTION -->
      <section id="lessonSection" class="hidden">
        <div class="card card-body-lg text-center">
          <h2 id="lessonTitle" class="mb-md"></h2>
          <div id="lessonText" class="text-left mb-lg" style="line-height: 1.9;"></div>
          <button class="btn btn-success btn-lg" id="startBtn" data-i18n="beginPractice">Begin Practice ğŸš€</button>
        </div>
      </section>

      <!-- GAME SECTION -->
      <section id="gameSection" class="hidden">
        <div class="game-stats">
          <div class="stat-item"><div class="stat-value" id="timeVal">15:00</div><div class="stat-label" data-i18n="timeLabel">Time</div></div>
          <div class="stat-item"><div class="stat-value" id="scoreVal">0</div><div class="stat-label" data-i18n="scoreLabel">Score</div></div>
          <div class="stat-item"><div class="stat-value" id="streakVal">0</div><div class="stat-label" data-i18n="streakLabel">Streak</div></div>
          <div class="stat-item"><div class="stat-value" id="levelVal">1</div><div class="stat-label" data-i18n="levelLabel">Level</div></div>
          <div class="stat-item"><div class="stat-value" id="highVal">0</div><div class="stat-label" data-i18n="bestLabel">Best</div></div>
        </div>
        
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        
        <div class="problem-area">
          <div id="streakFire" class="streak-fire hidden">ğŸ”¥</div>
          <div class="problem-visual hidden" id="visualArea"><canvas id="canvas" width="380" height="280"></canvas></div>
          <div class="problem-text" id="problemText">?</div>
          <div class="answer-area">
            <input type="text" id="answerInput" class="answer-input" placeholder="?" autocomplete="off" inputmode="text">
            <button class="btn btn-primary" id="submitBtn" data-i18n="submit">Submit</button>
          </div>
          <div class="feedback" id="feedback"></div>
        </div>
        
        <div class="text-center mt-lg">
          <button class="btn btn-ghost" id="changeBtn" data-i18n="changeTopic">â† Change Topic</button>
        </div>
      </section>

      <!-- END SECTION -->
      <section id="endSection" class="hidden">
        <div class="card card-body-lg end-screen">
          <div class="end-emoji">ğŸ‰</div>
          <h2 data-i18n="practiceComplete">Practice Complete!</h2>
          <div class="end-score" id="finalScore">0</div>
          <p class="end-message" id="endMessage">Great job!</p>
          <p><span data-i18n="highScore">High Score:</span> <strong id="finalHigh">0</strong></p>
          <button class="btn btn-primary btn-lg mt-lg" id="menuBtn" data-i18n="returnMenu">Return to Menu</button>
        </div>
      </section>
      
    </div>
  </main>

  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <a href="index.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ </span><span data-i18n="home">Home</span></a>
      <a href="resources.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ“–</span><span data-i18n="books">Books</span></a>
      <a href="classical_math.html" class="bottom-nav-item active"><span class="bottom-nav-icon">ğŸ”¢</span><span data-i18n="math">Math</span></a>
      <a href="dashboard.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ“Š</span><span data-i18n="progress">Progress</span></a>
      <a href="parents-guide.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span data-i18n="parents">Parents</span></a>
    </div>
  </nav>

  <script>
  // i18n translations
  var translations = {
    en: {
      mathPractice: 'ğŸ”¢ Math Practice',
      mathSubtitle: 'Choose a topic and sharpen your skills!',
      counting: 'Counting', addition: 'Addition', subtraction: 'Subtraction',
      multiplication: 'Multiplication', division: 'Division', fractions: 'Fractions',
      geometry: 'Geometry', time: 'Time', money: 'Money', measurement: 'Measurement',
      patterns: 'Patterns', challenge: 'Challenge',
      beginPractice: 'Begin Practice ğŸš€', submit: 'Submit', changeTopic: 'â† Change Topic',
      timeLabel: 'Time', scoreLabel: 'Score', streakLabel: 'Streak', levelLabel: 'Level', bestLabel: 'Best',
      practiceComplete: 'Practice Complete!', highScore: 'High Score:', returnMenu: 'Return to Menu',
      home: 'Home', resources: 'Resources', math: 'Math', progress: 'Progress', parents: 'Parents', books: 'Books'
    },
    es: {
      mathPractice: 'ğŸ”¢ PrÃ¡ctica de MatemÃ¡ticas',
      mathSubtitle: 'Â¡Elige un tema y mejora tus habilidades!',
      counting: 'Contar', addition: 'Suma', subtraction: 'Resta',
      multiplication: 'MultiplicaciÃ³n', division: 'DivisiÃ³n', fractions: 'Fracciones',
      geometry: 'GeometrÃ­a', time: 'Hora', money: 'Dinero', measurement: 'Medidas',
      patterns: 'Patrones', challenge: 'DesafÃ­o',
      beginPractice: 'Comenzar PrÃ¡ctica ğŸš€', submit: 'Enviar', changeTopic: 'â† Cambiar Tema',
      timeLabel: 'Tiempo', scoreLabel: 'Puntos', streakLabel: 'Racha', levelLabel: 'Nivel', bestLabel: 'Mejor',
      practiceComplete: 'Â¡PrÃ¡ctica Completa!', highScore: 'RÃ©cord:', returnMenu: 'Volver al MenÃº',
      home: 'Inicio', resources: 'Recursos', math: 'MatemÃ¡ticas', progress: 'Progreso', parents: 'Padres', books: 'Libros'
    }
  };
  var currentLang = localStorage.getItem('ck_lang') || 'en';
  
  function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('ck_lang', lang);
    document.querySelectorAll('.lang-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
      var key = el.getAttribute('data-i18n');
      if (translations[lang] && translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });
  }
  
  // Initialize language on load
  document.addEventListener('DOMContentLoaded', function() {
    setLang(currentLang);
  });
  
  (function() {
    var mode = '', score = 0, streak = 0, level = 1, timeLeft = 900, qCount = 0, answer = null, timer = null;
    var maxQ = 50;
    
    var menuSection = document.getElementById('menuSection');
    var lessonSection = document.getElementById('lessonSection');
    var gameSection = document.getElementById('gameSection');
    var endSection = document.getElementById('endSection');
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    
    var lessons = {
      counting: { title: 'ğŸ Counting', text: '<p><strong>Counting</strong> is the foundation of all math! Count the objects carefully and enter the total.</p><p>ğŸ’¡ <strong>Tip:</strong> Touch each object as you count to avoid mistakes.</p>' },
      addition: { title: 'â• Addition', text: '<p><strong>Addition</strong> means combining numbers. When you add, you find the total!</p><p>ğŸ’¡ <strong>Example:</strong> 3 + 5 = 8 (3 apples plus 5 apples = 8 apples!)</p>' },
      subtraction: { title: 'â– Subtraction', text: '<p><strong>Subtraction</strong> means taking away. Start with a number and remove some.</p><p>ğŸ’¡ <strong>Example:</strong> 10 - 4 = 6 (10 cookies minus 4 eaten = 6 left)</p>' },
      multiplication: { title: 'âœ–ï¸ Multiplication', text: '<p><strong>Multiplication</strong> is repeated addition! 3 Ã— 4 means adding 3 four times.</p><p>ğŸ’¡ <strong>Tip:</strong> Practice times tables to become a math champion!</p>' },
      division: { title: 'â— Division', text: '<p><strong>Division</strong> means sharing equally. 12 Ã· 3 = 4 means 12 shared among 3.</p><p>ğŸ’¡ <strong>Tip:</strong> Division is the opposite of multiplication!</p>' },
      fractions: { title: 'ğŸ¥§ Fractions', text: '<p><strong>Fractions</strong> show parts of a whole. The top number shows parts you have, bottom shows total parts.</p><p>ğŸ’¡ <strong>Answer format:</strong> numerator/denominator (example: 2/3)</p>' },
      geometry: { title: 'ğŸ“ Geometry', text: '<p><strong>Geometry</strong> is the study of shapes! Count the sides of each polygon.</p><p>ğŸ’¡ Triangle=3, Square=4, Pentagon=5, Hexagon=6, Octagon=8</p>' },
      time: { title: 'ğŸ• Time', text: '<p>Learn to read clocks! The short hand = hours, the long hand = minutes.</p><p>ğŸ’¡ <strong>Answer format:</strong> H:MM (example: 3:45)</p>' },
      money: { title: 'ğŸ’° Money', text: '<p>Count coins to find the total value in cents.</p><p>ğŸ’¡ Penny=1Â¢, Nickel=5Â¢, Dime=10Â¢, Quarter=25Â¢</p>' },
      measurement: { title: 'ğŸ“ Measurement', text: '<p><strong>Measurement</strong> helps us understand size. Add or subtract lengths!</p><p>ğŸ’¡ Look at the bars and calculate the total centimeters.</p>' },
      patterns: { title: 'ğŸ”¢ Patterns', text: '<p>Find the <strong>pattern</strong> in the sequence and predict the next number!</p><p>ğŸ’¡ <strong>Example:</strong> 2, 4, 6, ? â†’ The pattern is +2, so answer is 8</p>' },
      challenge: { title: 'ğŸ§  Challenge Mode', text: '<p><strong>Challenge Mode</strong> mixes ALL operations! You\'ll see addition, subtraction, multiplication, and division.</p><p>ğŸ’¡ <strong>Think carefully!</strong> Read each problem and identify the operation. Includes order of operations!</p><p>ğŸ† <strong>For advanced learners!</strong></p>' }
    };
    
    function showSection(s) {
      [menuSection, lessonSection, gameSection, endSection].forEach(function(el) { el.classList.add('hidden'); });
      s.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    document.getElementById('gameGrid').addEventListener('click', function(e) {
      var card = e.target.closest('.game-card');
      if (!card) return;
      mode = card.dataset.mode;
      document.getElementById('lessonTitle').textContent = lessons[mode].title;
      document.getElementById('lessonText').innerHTML = lessons[mode].text;
      showSection(lessonSection);
    });
    
    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('changeBtn').addEventListener('click', function() { clearInterval(timer); showSection(menuSection); });
    document.getElementById('menuBtn').addEventListener('click', function() { showSection(menuSection); });
    document.getElementById('submitBtn').addEventListener('click', checkAnswer);
    document.getElementById('answerInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') checkAnswer(); });
    
    function startGame() {
      score = 0; streak = 0; level = 1; timeLeft = 900; qCount = 0;
      updateStats();
      document.getElementById('highVal').textContent = getHigh();
      document.getElementById('streakFire').classList.add('hidden');
      showSection(gameSection);
      startTimer();
      nextProblem();
    }
    
    function startTimer() {
      clearInterval(timer);
      timer = setInterval(function() {
        timeLeft--;
        updateTime();
        if (timeLeft <= 0) endGame();
      }, 1000);
    }
    
    function updateTime() {
      var m = Math.floor(timeLeft / 60), s = timeLeft % 60;
      document.getElementById('timeVal').textContent = String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }
    
    function updateStats() {
      var scoreEl = document.getElementById('scoreVal');
      var streakEl = document.getElementById('streakVal');
      scoreEl.textContent = score;
      streakEl.textContent = streak;
      document.getElementById('levelVal').textContent = level;
      document.getElementById('progressBar').style.width = (qCount / maxQ * 100) + '%';
      
      // Bump animation
      scoreEl.classList.add('bump');
      setTimeout(function() { scoreEl.classList.remove('bump'); }, 300);
      
      // Show fire on streak
      var fire = document.getElementById('streakFire');
      if (streak >= 3) {
        fire.classList.remove('hidden');
        fire.textContent = streak >= 10 ? 'ğŸ”¥ğŸ”¥ğŸ”¥' : streak >= 5 ? 'ğŸ”¥ğŸ”¥' : 'ğŸ”¥';
      } else {
        fire.classList.add('hidden');
      }
    }
    
    function nextProblem() {
      qCount++;
      if (qCount > maxQ) { endGame(); return; }
      
      document.getElementById('feedback').textContent = '';
      document.getElementById('feedback').className = 'feedback';
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').className = 'answer-input';
      document.getElementById('visualArea').classList.add('hidden');
      
      var problem = '';
      switch(mode) {
        case 'counting': problem = genCounting(); break;
        case 'addition': problem = genAddition(); break;
        case 'subtraction': problem = genSubtraction(); break;
        case 'multiplication': problem = genMultiplication(); break;
        case 'division': problem = genDivision(); break;
        case 'fractions': problem = genFractions(); break;
        case 'geometry': problem = genGeometry(); break;
        case 'time': problem = genTime(); break;
        case 'money': problem = genMoney(); break;
        case 'measurement': problem = genMeasurement(); break;
        case 'patterns': problem = genPatterns(); break;
        case 'challenge': problem = genChallenge(); break;
      }
      
      document.getElementById('problemText').innerHTML = problem;
      document.getElementById('answerInput').focus();
      updateStats();
    }
    
    function checkAnswer() {
      var userAns = document.getElementById('answerInput').value.trim();
      if (!userAns) return;
      
      var isCorrect = false;
      if (mode === 'fractions' || mode === 'time') {
        isCorrect = userAns.toLowerCase() === String(answer).toLowerCase();
      } else {
        var num = parseFloat(userAns);
        isCorrect = !isNaN(num) && num === answer;
      }
      
      var input = document.getElementById('answerInput');
      var feedback = document.getElementById('feedback');
      
      if (isCorrect) {
        score++; streak++;
        if (streak % 3 === 0 && level < 5) level++;
        input.className = 'answer-input correct';
        feedback.textContent = ['ğŸ‰ Correct!', 'â­ Awesome!', 'ğŸš€ Amazing!', 'ğŸ’ª Perfect!', 'âœ¨ Brilliant!'][Math.floor(Math.random()*5)];
        feedback.className = 'feedback correct';
        if (streak % 5 === 0) doConfetti(40);
        setTimeout(nextProblem, 600);
      } else {
        streak = 0;
        if (level > 1) level--;
        input.className = 'answer-input wrong';
        feedback.textContent = 'âŒ Answer: ' + answer;
        feedback.className = 'feedback wrong';
        setTimeout(nextProblem, 1400);
      }
      updateStats();
    }
    
    function endGame() {
      clearInterval(timer);
      if (score > getHigh()) setHigh(score);
      document.getElementById('finalScore').textContent = score;
      document.getElementById('finalHigh').textContent = getHigh();
      var msg = score >= 45 ? 'ğŸ† Legendary!' : score >= 35 ? 'ğŸ‘‘ Math Champion!' : score >= 25 ? 'â­ Great job!' : score >= 15 ? 'ğŸ‘ Good effort!' : 'ğŸ’ª Keep practicing!';
      document.getElementById('endMessage').textContent = msg;
      showSection(endSection);
      doConfetti(120);
    }
    
    // PROBLEM GENERATORS
    function genCounting() {
      var n = rand(1, 5 + level * 2);
      answer = n;
      var items = ['ğŸ','ğŸŠ','â­','ğŸŒ¸','ğŸˆ','ğŸ¦‹','ğŸ±','ğŸ¶','ğŸ','ğŸŒ»'][rand(0,9)];
      var display = '';
      for (var i = 0; i < n; i++) display += items + ' ';
      return '<div style="font-size: 2.5rem; line-height: 1.6;">' + display + '</div><div style="margin-top: 1rem;">How many?</div>';
    }
    
    function genAddition() {
      var max = 5 + level * 5;
      var a = rand(1, max), b = rand(1, max);
      answer = a + b;
      return '<span style="color:#5DB075">' + a + '</span> + <span style="color:#4A90D9">' + b + '</span> = ?';
    }
    
    function genSubtraction() {
      var max = 5 + level * 5;
      var a = rand(5, max), b = rand(1, a);
      answer = a - b;
      return '<span style="color:#4A90D9">' + a + '</span> âˆ’ <span style="color:#E8845F">' + b + '</span> = ?';
    }
    
    function genMultiplication() {
      var max = 2 + level * 2;
      var a = rand(1, Math.min(12, max)), b = rand(1, Math.min(12, max));
      answer = a * b;
      return '<span style="color:#9B5DE5">' + a + '</span> Ã— <span style="color:#F5C842">' + b + '</span> = ?';
    }
    
    function genDivision() {
      var divisor = rand(2, 5 + level);
      var quotient = rand(1, 10);
      var dividend = divisor * quotient;
      answer = quotient;
      return '<span style="color:#4A90D9">' + dividend + '</span> Ã· <span style="color:#E8845F">' + divisor + '</span> = ?';
    }
    
    function genFractions() {
      document.getElementById('visualArea').classList.remove('hidden');
      var total = rand(2, 4 + level);
      // Ensure filled can be any value from 1 to total (inclusive), for variety
      var filled = rand(1, total);
      answer = filled + '/' + total;
      drawFractionBar(filled, total);
      return 'What fraction is shaded?<br><small style="color:#718096">(e.g., 2/3)</small>';
    }
    
    function genGeometry() {
      document.getElementById('visualArea').classList.remove('hidden');
      var sides = [3,4,5,6,8][rand(0, 4)];
      answer = sides;
      drawPolygon(sides);
      return 'How many sides?';
    }
    
    function genTime() {
      document.getElementById('visualArea').classList.remove('hidden');
      var h = rand(1, 12), m = rand(0, 11) * 5;
      var add = rand(5, 30);
      var totalM = h * 60 + m + add;
      var newH = Math.floor(totalM / 60) % 12 || 12;
      var newM = totalM % 60;
      answer = newH + ':' + String(newM).padStart(2,'0');
      drawClock(h, m);
      return 'Clock shows ' + h + ':' + String(m).padStart(2,'0') + '<br>What time in <strong>' + add + ' min</strong>?<br><small style="color:#718096">(H:MM)</small>';
    }
    
    function genMoney() {
      document.getElementById('visualArea').classList.remove('hidden');
      var p = rand(0, 4), n = rand(0, 3), d = rand(0, 3), q = rand(0, 2);
      // Ensure at least some coins
      if (p + n + d + q === 0) p = rand(1, 3);
      answer = p + n*5 + d*10 + q*25;
      drawMoney(p, n, d, q);
      return 'Total cents?';
    }
    
    function genMeasurement() {
      document.getElementById('visualArea').classList.remove('hidden');
      var a = rand(2, 10), b = rand(1, 8);
      var op = Math.random() < 0.5 ? '+' : '-';
      if (op === '-' && b > a) { var t = a; a = b; b = t; }
      answer = op === '+' ? a + b : a - b;
      drawMeasurement(a, b, op);
      return '<span style="color:#4A90D9">' + a + ' cm</span> ' + (op === '+' ? '+' : 'âˆ’') + ' <span style="color:#5DB075">' + b + ' cm</span> = ?';
    }
    
    function genPatterns() {
      var diff = rand(1, 5);
      var isDecreasing = Math.random() < 0.3;
      // For decreasing patterns, ensure start is high enough so answer stays positive
      var start = isDecreasing ? rand(diff * 4, diff * 4 + 10) : rand(1, 10);
      if (isDecreasing) diff = -diff;
      var seq = [start, start+diff, start+2*diff];
      answer = start + 3*diff;
      return 'Pattern: <strong>' + seq.join(', ') + ', ?</strong>';
    }
    
    function genChallenge() {
      var type = rand(1, 5);
      var a, b, c, op;
      
      switch(type) {
        case 1: // Two-step: a + b Ã— c
          a = rand(1, 10); b = rand(2, 5); c = rand(2, 5);
          answer = a + b * c;
          return a + ' + ' + b + ' Ã— ' + c + ' = ?<br><small style="color:#718096">Remember: Ã— before +</small>';
        case 2: // Two-step: a Ã— b - c
          a = rand(2, 6); b = rand(2, 6); c = rand(1, a*b - 1);
          answer = a * b - c;
          return a + ' Ã— ' + b + ' âˆ’ ' + c + ' = ?';
        case 3: // Parentheses: (a + b) Ã— c
          a = rand(1, 8); b = rand(1, 8); c = rand(2, 5);
          answer = (a + b) * c;
          return '(' + a + ' + ' + b + ') Ã— ' + c + ' = ?<br><small style="color:#718096">Solve parentheses first!</small>';
        case 4: // Mixed: a Ã— b + c Ã— d
          a = rand(2, 5); b = rand(2, 5); c = rand(2, 5); var d = rand(2, 5);
          answer = a * b + c * d;
          return a + ' Ã— ' + b + ' + ' + c + ' Ã— ' + d + ' = ?';
        case 5: // Division + addition
          a = rand(2, 6); b = rand(2, 12); c = rand(1, 10);
          var dividend = a * b;
          answer = b + c;
          return dividend + ' Ã· ' + a + ' + ' + c + ' = ?';
        default:
          return genAddition();
      }
    }
    
    // DRAWING FUNCTIONS
    function drawFractionBar(filled, total) {
      ctx.clearRect(0, 0, 380, 280);
      var w = 280 / total, h = 80;
      var x0 = (380 - 280) / 2, y0 = 100;
      
      for (var i = 0; i < total; i++) {
        // Gradient fill for filled parts
        if (i < filled) {
          var grad = ctx.createLinearGradient(x0 + i * w, y0, x0 + i * w, y0 + h);
          grad.addColorStop(0, '#6BA3E3');
          grad.addColorStop(1, '#4A90D9');
          ctx.fillStyle = grad;
        } else {
          ctx.fillStyle = '#F0EBE5';
        }
        ctx.fillRect(x0 + i * w + 2, y0, w - 4, h);
        
        // Border
        ctx.strokeStyle = i < filled ? '#3A7BC8' : '#D8D0C8';
        ctx.lineWidth = 2;
        ctx.strokeRect(x0 + i * w + 2, y0, w - 4, h);
      }
      
      // Label
      ctx.fillStyle = '#2D3748';
      ctx.font = 'bold 16px Quicksand';
      ctx.textAlign = 'center';
      ctx.fillText(filled + ' out of ' + total + ' shaded', 190, 220);
    }
    
    function drawPolygon(sides) {
      ctx.clearRect(0, 0, 380, 280);
      var cx = 190, cy = 140, r = 80;
      
      // Shadow
      ctx.beginPath();
      for (var i = 0; i < sides; i++) {
        var angle = (i * 2 * Math.PI / sides) - Math.PI / 2;
        var x = cx + 3 + r * Math.cos(angle), y = cy + 3 + r * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.fillStyle = 'rgba(0,0,0,0.1)';
      ctx.fill();
      
      // Main shape with gradient
      ctx.beginPath();
      for (var i = 0; i < sides; i++) {
        var angle = (i * 2 * Math.PI / sides) - Math.PI / 2;
        var x = cx + r * Math.cos(angle), y = cy + r * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.closePath();
      
      var grad = ctx.createRadialGradient(cx - 20, cy - 20, 0, cx, cy, r);
      grad.addColorStop(0, 'rgba(107,163,227,0.4)');
      grad.addColorStop(1, 'rgba(74,144,217,0.2)');
      ctx.fillStyle = grad;
      ctx.fill();
      
      ctx.strokeStyle = '#4A90D9';
      ctx.lineWidth = 4;
      ctx.stroke();
      
      // Dots at vertices
      for (var i = 0; i < sides; i++) {
        var angle = (i * 2 * Math.PI / sides) - Math.PI / 2;
        var x = cx + r * Math.cos(angle), y = cy + r * Math.sin(angle);
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);
        ctx.fillStyle = '#4A90D9';
        ctx.fill();
      }
    }
    
    function drawClock(h, m) {
      ctx.clearRect(0, 0, 380, 280);
      var cx = 190, cy = 140, r = 95;
      
      // Shadow
      ctx.beginPath();
      ctx.arc(cx + 3, cy + 3, r, 0, 2*Math.PI);
      ctx.fillStyle = 'rgba(0,0,0,0.1)';
      ctx.fill();
      
      // Clock face
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, 2*Math.PI);
      var grad = ctx.createRadialGradient(cx - 30, cy - 30, 0, cx, cy, r);
      grad.addColorStop(0, '#FFFFFF');
      grad.addColorStop(1, '#F9F5F0');
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.strokeStyle = '#4A90D9';
      ctx.lineWidth = 4;
      ctx.stroke();
      
      // Hour markers
      for (var i = 0; i < 12; i++) {
        var a = i * Math.PI / 6 - Math.PI / 2;
        var isHour = i % 3 === 0;
        ctx.beginPath();
        ctx.moveTo(cx + (r - (isHour ? 18 : 12)) * Math.cos(a), cy + (r - (isHour ? 18 : 12)) * Math.sin(a));
        ctx.lineTo(cx + (r - 6) * Math.cos(a), cy + (r - 6) * Math.sin(a));
        ctx.strokeStyle = '#2D3748';
        ctx.lineWidth = isHour ? 3 : 2;
        ctx.stroke();
      }
      
      // Numbers
      ctx.fillStyle = '#2D3748';
      ctx.font = 'bold 14px Quicksand';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      [12,3,6,9].forEach(function(num) {
        var a = (num % 12) * Math.PI / 6 - Math.PI / 2;
        ctx.fillText(num, cx + (r - 28) * Math.cos(a), cy + (r - 28) * Math.sin(a));
      });
      
      // Hour hand
      var ha = ((h % 12) + m / 60) * Math.PI / 6 - Math.PI / 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + 45 * Math.cos(ha), cy + 45 * Math.sin(ha));
      ctx.strokeStyle = '#2D3748';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // Minute hand
      var ma = m * Math.PI / 30 - Math.PI / 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + 65 * Math.cos(ma), cy + 65 * Math.sin(ma));
      ctx.strokeStyle = '#4A90D9';
      ctx.lineWidth = 4;
      ctx.stroke();
      
      // Center dot
      ctx.beginPath();
      ctx.arc(cx, cy, 8, 0, 2*Math.PI);
      ctx.fillStyle = '#E8845F';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(cx, cy, 4, 0, 2*Math.PI);
      ctx.fillStyle = '#2D3748';
      ctx.fill();
    }
    
    function drawMoney(p, n, d, q) {
      ctx.clearRect(0, 0, 380, 280);
      
      var coins = [
        { count: q, value: '25Â¢', name: 'Quarter', color: '#C9B037', stroke: '#A89030', size: 28 },
        { count: d, value: '10Â¢', name: 'Dime', color: '#C0C0C0', stroke: '#A0A0A0', size: 20 },
        { count: n, value: '5Â¢', name: 'Nickel', color: '#B8B8B8', stroke: '#909090', size: 24 },
        { count: p, value: '1Â¢', name: 'Penny', color: '#B87333', stroke: '#8B5A2B', size: 22 }
      ];
      
      var y = 45;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      coins.forEach(function(coin) {
        if (coin.count > 0) {
          // Label
          ctx.fillStyle = '#718096';
          ctx.font = '12px Quicksand';
          ctx.textAlign = 'left';
          ctx.fillText(coin.name + 's:', 20, y);
          
          // Draw coins
          for (var i = 0; i < coin.count; i++) {
            var cx = 120 + i * (coin.size * 2 + 8);
            
            // Shadow
            ctx.beginPath();
            ctx.arc(cx + 2, y + 2, coin.size, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fill();
            
            // Coin gradient
            var grad = ctx.createRadialGradient(cx - coin.size/3, y - coin.size/3, 0, cx, y, coin.size);
            grad.addColorStop(0, lightenColor(coin.color, 30));
            grad.addColorStop(0.5, coin.color);
            grad.addColorStop(1, coin.stroke);
            
            ctx.beginPath();
            ctx.arc(cx, y, coin.size, 0, 2 * Math.PI);
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.strokeStyle = coin.stroke;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Inner ring
            ctx.beginPath();
            ctx.arc(cx, y, coin.size - 4, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // Value text
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold ' + (coin.size * 0.6) + 'px Quicksand';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 2;
            ctx.fillText(coin.value, cx, y + 1);
            ctx.shadowBlur = 0;
          }
          y += coin.size * 2 + 15;
        }
      });
    }
    
    function lightenColor(hex, percent) {
      var num = parseInt(hex.replace('#', ''), 16);
      var r = Math.min(255, (num >> 16) + percent);
      var g = Math.min(255, ((num >> 8) & 0x00FF) + percent);
      var b = Math.min(255, (num & 0x0000FF) + percent);
      return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
    }
    
    function drawMeasurement(a, b, op) {
      ctx.clearRect(0, 0, 380, 280);
      var scale = 22, h = 35;
      var x0 = 40;
      
      // First bar with gradient
      var grad1 = ctx.createLinearGradient(x0, 100, x0, 100 + h);
      grad1.addColorStop(0, '#6BA3E3');
      grad1.addColorStop(1, '#4A90D9');
      ctx.fillStyle = grad1;
      ctx.fillRect(x0, 100, a * scale, h);
      ctx.strokeStyle = '#3A7BC8';
      ctx.lineWidth = 2;
      ctx.strokeRect(x0, 100, a * scale, h);
      
      // Label
      ctx.fillStyle = '#FFF';
      ctx.font = 'bold 14px Quicksand';
      ctx.textAlign = 'center';
      ctx.fillText(a + ' cm', x0 + a * scale / 2, 100 + h/2 + 1);
      
      // Second bar
      var grad2 = ctx.createLinearGradient(x0, 160, x0, 160 + h);
      grad2.addColorStop(0, op === '+' ? '#6BC88B' : '#F5A08A');
      grad2.addColorStop(1, op === '+' ? '#5DB075' : '#F28482');
      ctx.fillStyle = grad2;
      ctx.fillRect(x0, 160, b * scale, h);
      ctx.strokeStyle = op === '+' ? '#4A9660' : '#D67470';
      ctx.strokeRect(x0, 160, b * scale, h);
      
      ctx.fillStyle = '#FFF';
      ctx.fillText(b + ' cm', x0 + b * scale / 2, 160 + h/2 + 1);
      
      // Operation symbol
      ctx.fillStyle = '#2D3748';
      ctx.font = 'bold 24px Quicksand';
      ctx.fillText(op === '+' ? '+' : 'âˆ’', 20, 145);
    }
    
    // UTILITIES
    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function getHigh() { return parseInt(localStorage.getItem('mathHigh_' + mode) || '0'); }
    function setHigh(v) { localStorage.setItem('mathHigh_' + mode, v); }
    
    function doConfetti(n) {
      var colors = ['#4A90D9','#5DB075','#F5C842','#E8845F','#9B5DE5','#F28482'];
      for (var i = 0; i < n; i++) {
        var c = document.createElement('div');
        var size = 6 + Math.random() * 10;
        c.style.cssText = 'position:fixed;width:' + size + 'px;height:' + size + 'px;top:-20px;left:' + (Math.random()*100) + 'vw;background:' + colors[rand(0,5)] + ';z-index:9999;pointer-events:none;border-radius:' + (Math.random()>.5?'50%':'2px') + ';animation:confetti-fall ' + (2+Math.random()*2) + 's linear forwards;animation-delay:' + (Math.random()*0.5) + 's;';
        document.body.appendChild(c);
        setTimeout(function(el) { el.remove(); }, 4500, c);
      }
    }
  })();
  </script>
</body>
</html>
